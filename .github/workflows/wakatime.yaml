name: Scheduled WakaTime Update

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Allow to automate by schedule
  schedule:
    - cron: '*/5 * * * *'  # Run every 5 minutes

jobs:
  update-wakatime:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set global config
      run: |
        git config --global bot.name 'GitHub Actions Bot'
        git config --global bot.email 'actions@github.com'
    
    - name: Set branch name based
      run: |
        echo "BRANCH_NAME=workflow/wakatime_stats" >> $GITHUB_ENV
        echo "BOT_ACTION_NAME=$(git config --global bot.name)" >> $GITHUB_ENV
        echo "BOT_ACTION_MAIL=$(git config --global bot.email)" >> $GITHUB_ENV

    - name: Setup branch '${{ env.BRANCH_NAME }}'
      run: |
        git fetch origin
        git checkout -B ${{ env.BRANCH_NAME }}
        git reset --hard origin/main

    - name: Update README using WakaTime
      id: wakatime
      uses: athul/waka-readme@master
      with:
        WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        BLOCKS: ⣀⣄⣤⣦⣶⣷⣿
        AUTHOR_NAME: ${{ env.BOT_ACTION_NAME }}
        AUTHOR_EMAIL: ${{ env.BOT_ACTION_MAIL }}
        TARGET_BRANCH: ${{ env.BRANCH_NAME }}

    - name: Commit and push branch
      run: |
        git add .
        git commit -m "Update WakaTime stats" || echo "No changes to commit"
        git push -f origin ${{ env.BRANCH_NAME }}

    - name: Create Pull Request if not exists
      uses: peter-evans/create-pull-request@v3
      with:
        title: "Update WakaTime stats"
        body: "This PR updates the WakaTime stats."
        branch: ${{ env.BRANCH_NAME }}
        base: main
        modify: true
