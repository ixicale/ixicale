name: Scheduled WakaTime Update

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  # Allow to automate by schedule
  schedule:
    - cron: '0 0 * * *'  # Runs at 00:00

jobs:
  update-wakatime:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    
    - name: Setup ENV values
      run: |
        echo "BRANCH_NAME=workflow/wakatime_stats" >> $GITHUB_ENV
        echo "BOT_ACTION_NAME='GitHub Actions Bot'" >> $GITHUB_ENV
        echo "BOT_ACTION_MAIL='actions@github.com'" >> $GITHUB_ENV

    - name: Set up GitHub CLI
      # secrets.GITHUB_TOKEN is generated automatically
      run: |
        gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}" 

    - name: Reset branch '${{ env.BRANCH_NAME }}'
      # Create the branch but if exists, this should checkout there and then, reset with origin/main
      # This job is up to you!
      run: |
        git config --global user.name ${{ env.BOT_ACTION_NAME }}
        git config --global user.email ${{ env.BOT_ACTION_MAIL }}
        git fetch origin
        git checkout -B ${{ env.BRANCH_NAME }}
        git reset --hard origin/main
        git push -f origin ${{ env.BRANCH_NAME }}

    - name: Update README using WakaTime
      id: wakatime
      uses: athul/waka-readme@master
      with:
        WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        BLOCKS: ⣀⣄⣤⣦⣶⣷⣿
        AUTHOR_NAME: ${{ env.BOT_ACTION_NAME }}
        AUTHOR_EMAIL: ${{ env.BOT_ACTION_MAIL }}
        TARGET_BRANCH: ${{ env.BRANCH_NAME }}

    - name: Create Pull Request
      run: |
        git fetch origin
        git pull origin ${{ env.BRANCH_NAME }}
        gh pr create \
          --base main --head ${{ env.BRANCH_NAME }} \
          --title "workflow/wakatime_stats (README updates)" \
          --body "README updated from workflow using wakatime"
